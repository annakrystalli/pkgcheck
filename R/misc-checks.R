
#' Check whether all man files have been generated by 'roxygen2'
#'
#' @param path Path to local source repository
#' @return 'TRUE' if all files generated by 'roxygen2', otherwise 'FALSE'
#' @export
pkg_uses_roxygen2 <- function (path) {

    rd <- list.files (file.path (path, "man"),
                      pattern = "\\.Rd$",
                      full.names = TRUE)

    chk <- vapply (rd, function (i) {
                       l1 <- readLines (i, n = 1L, encoding = "UTF-8")
                       grepl ("Generated by roxygen2", l1, ignore.case = TRUE)
                       },
                       logical (1),
                       USE.NAMES = FALSE)

    return (all (chk))
}

#' Check whether package has 'contributing.md', as well as whether it has a
#' life cycle statement
#'
#' @inheritParams pkg_uses_roxygen2
#' @return Vector of two logical values, the first one identifying whether a
#' package has a 'contributing.md' file or not; the second whether this file has
#' a life cycle statement
#' @export
pkg_has_contrib_md <- function (path) {

    flist <- list.files (path, full.names = TRUE)

    f <- grep (paste0 (.Platform$file.sep, "contributing\\.md$"),
               flist,
               ignore.case = TRUE)

    has_lifecycle <- FALSE
    if (length (f) == 1L) {

        contrib <- readLines (flist [f], encoding = "UTF-8") 

        has_lifecycle <- any (grepl ("life\\s?cycle", contrib, ignore.case = TRUE))
    }

    return (c (has_contrib = length (f) == 1L,
               has_lifecycle = has_lifecycle))
}


#' Check whether package 'DESCRIPTION' file has URL + BugReports fields
#'
#' @inheritParams pkg_uses_roxygen2
#' @return Vector of two logical values, the first one identifying whether a
#' package's 'DESCRIPTION' file has a 'URL' field or not; the second whether
#' there is a 'BugReports' field.
#' @export
pkg_desc_has_url <- function (path) {

    desc <- data.frame (read.dcf (file.path (path, "DESCRIPTION")))

    return (c (url = "URL" %in% names (desc),
               bugs = "BugReports" %in% names (desc)))

}

get_Rd_meta <- utils::getFromNamespace (".Rd_get_metadata", "tools")


#' Check whether all functions have examples
#'
#' @inheritParams pkg_uses_roxygen2
#' @return Vector of named logical values, one for each '.Rd' file indicating
#' whether or not it has example lines.
#' @export
all_pkg_fns_have_exs <- function (path) {

    rd <- list.files (file.path (path, "man"),
                      pattern = "\\.Rd$",
                      full.names = TRUE)

    has_ex <- vapply (rd, function (i) {
                          rd_i <- tools::parse_Rd (i)
                          ex <- get_Rd_meta (rd_i, "examples")
                          length (ex) > 0
                      },
                      logical (1),
                      USE.NAMES = TRUE)

    names (has_ex) <- vapply (names (has_ex), function (i)
                              utils::tail (strsplit (i, .Platform$file.sep) [[1]], 1),
                              character (1))

    return (has_ex)
}
